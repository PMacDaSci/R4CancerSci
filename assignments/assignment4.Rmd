
---
title: "Assignment 4"
---

The week's assignment will test your ability to manipulate the METABRIC data set
by changing the values of existing columns or adding new columns by computing
new variables from existing ones.

We are expecting you to use the 5 main dplyr 'verb' functions: `select()`,
`filter()`, `arrange()`, `mutate()` and `summarize()`. Please use the pipe
operator, `%>%`, in cases where more than one operation is required to achieve
the outcome requested.

```{r message = FALSE, warning = FALSE}
library(tidyverse)
```

```{r eval = FALSE, message = FALSE, warning = FALSE}
metabric <- read_csv("metabric_clinical_and_expression_data.csv")
```

---

**1. Investigate the subset of long-surviving breast cancer patients that didn't receive chemo or radiotherapy**

First obtain the subset of patients that received neither chemotherapy or
radiotherapy and survived for more than 20 years.

```{r}

```

Now look at the breakdown of these patients in terms of ER status. Count the
numbers of ER positive and ER negative patients in this subset. Calculate the
proportion that are ER positive.

```{r}

```

What does this tell us? Calculate the proportion of ER positive patients in the
whole cohort by way of a comparison.

```{r}

```

**Extension**

Create a contingency table of the numbers of ER positive and ER negative
patients in the two groups (untreated, long-surviving patients and all others)
and perform a Chi-squared test or a Fisher's exact test (whichever is most
appropriate) to determine if there is a significant difference.

```{r}

```

_Hint: look at the help page for the function for the Chi-squared or Fisher's
exact test to see what form the contingency table needs to take_

---

**2. Which patients have spent the largest proportion of their lives dealing with breast cancer?**

```{r}

```

---

**3. Convert the expression values for each of the genes into standardized z-scores**

Some genes are generally expressed at higher levels than others. This can make
comparisons of changes between groups for a set of genes somewhat difficult,
particularly if the expression for those genes are on very different scales. The
expression values in our METABRIC are on a log~2~ scale which helps to reduce
the range of values but another method for representing expression measurements
is to standardize these to produce z-scores.

Standardization of a set of measurements involves subtracting the mean from each
and dividing by the standard deviation. This will produce values with a mean of
0 and a standard deviation of 1.

Create a modified version of the `metabric` data frame containing a new column
with the standardized expression values (z-scores) for the ESR1 gene.

```{r}

```

Check that you've done this correctly by calculating the mean and standard
deviation of your new z-score variable.

```{r}

```

Add another column to your modified `metabric` data frame containing a z-score
for GATA3 and then create a scatter plot of the z-scores of GATA3 against ESR1.
Modify your plot to facet by the PAM50 classification.

```{r}

```

**Extension 1**

Standardize the expression values for all genes in a single operation using an
anonymous function, overwriting their original values, and round the resulting
values to 3 significant figures.

```{r}

```

Check you have done this correctly by computing the mean and standard deviation for
each column, again using a single operation.

```{r}

```

To be doubly certain, you could also download the expression z-score values for
these genes from cBioPortal.

**Extension 2**

Create a plot comparing the distribution of standardized expression values for
TP53 against a normal distribution.

```{r}

```

_Hint: use `stat_function()`_

---

**4. Which Star Wars characters need to go on a diet?**

Compute the body mass index (BMI) of characters in the `starwars` tibble.

```{r}

```

Filter for human characters that are overweight (BMI > 25) and display in
decreasing order of BMI.

```{r}

```

The next part involves transforming two data sets in order to ask a specific
question of each. The first is a more complete set of data on the number of new
tuberculosis cases each year from 1980 to 2013 in 219 countries, taken from the
[World Health Organization Global Tuberculosis Report](https://www.who.int/health-topics/tuberculosis).

For the second "real world" example we return to the METABRIC data set and
introduce the other set of assay data obtained as part of the original 2012
study that concerns genomic copy number. We'll transform the copy number data
downloaded from [cBioPortal](https://www.cbioportal.org/study/summary?id=brca_metabric)
so that we can look at the copy number states for some of our favourite genes
and then combine that with the expression data to see how copy number influences
gene expression.

The clinical data, gene expression values and mutation data were all downloaded
from [cBioPortal](https://www.cbioportal.org/study/summary?id=brca_metabric).

---

**5. Tidy the WHO tuberculosis data set**

In this week's materials we demonstrated the restructuring of different
representations of a very small subset of the WHO tuberculosis data set (tables
1 to 4a and b). The more complete data set is also available in its original
format in another data frame available as part of the **tidyr** package, named
`who`.

```{r}
who
```

What are the variables in this data set?

Create a bulleted list with your answer here.



_Hint: see the help page for `who` to understand the meaning of the column headings._

_Hint: the Markdown Quick Reference available from the Help menu in RStudio is a very useful guide to formatting text in R markdown documents._

Why isn't this data set tidy and what kinds of analysis are not straightforward
with the data in this format?

Transform the data into a tidy format.

Columns `new_sp_m014` to `newrel_f65` are values for a compound variable, i.e.
multiple variables joined together - the restructured data frame should have
columns for each of the separated values in these column headings.

Also remove all rows with missing values for the number of tuberculosis cases.

```{r}

```

*Hint 1: the column headers from new_sp_m014 onwards contain a superfluous prefix "new" or "new_" that you will want to remove; this can be done using one of the stringr functions in a single step if you know about regular expressions but is also achievable in two steps if you don't use any regular expression magic.*

_Hint 2: separating two of the variables is a bit tricky because there is no separator character; try looking at the help for the separate function to see how this can be done._

---

**6. Recreate `table1` from your tidy version of the WHO tuberculosis data set**

Recreate the first 3 columns of `table1`, containing a small subset of the WHO
tuberculosis data set, from your tidy version of `who`.

```{r eval = FALSE}
select(table1, 1:3)
```

```{r}

```

_Hint: this will involve some filtering, grouping and summarization._

---

**7. Create time series plots for cases of tuberculosis**

Create a time series plot showing the number of tuberculosis cases in the United
Kingdom with separate lines for each age group. The year should be on the x axis
and the number of cases on the y axis.

```{r}

```

_Hint: we're not distinguishing between diagnoses and genders in this plot so you'll need to sum the numbers of cases for each country, year and age group._

Use faceting in ggplot2 to create a series of plots showing the same information
for France, Brazil, Japan and Uganda.

The numbers of cases in these countries are on quite different scales. Look at
help page for `facet_wrap()` and try changing the `scales` argument so we can
more easily compare the overall patterns between countries.

```{r}

```

---

**8. Relate METABRIC copy number and expression data**

For this exercise we'll read in the METABRIC mRNA expression data and copy
number states into separate data frames. The aim is to see how the gene
expression is affected by the copy number state of various genes through a
series of box plot.

```{r eval = FALSE, message = FALSE}
expression <- read_tsv("metabric_mrna_expression.txt")
```

The expression data is in a matrix-like format with a row for each sample and a
column for each gene. This is the format used when downloading data from
[cBioPortal](https://www.cbioportal.org/study/summary?id=brca_metabric) after
selecting a set of genes.

```{r}
expression
```

Convert this data frame into a tidy format with a row-per-sample-per-gene.
Remove the rather uninteresting `STUDY_ID` column and filter out missing
expression values (for those samples that weren't assayed).

```{r}

```

The copy number data are also in a matrix-like format but this time we have a
row for each gene and a column for each sample. It is a very wide table
containing 2175 columns (only the first 10 displayed below). This is the format
of the copy number table you obtain if you download the complete METABRIC
dataset from cBioPortal. The table read in is a subset containing rows for
the 8 genes we've been using up till now.

```{r eval = FALSE, message = FALSE}
copy_number_states <- read_tsv("metabric_cna.txt")
select(copy_number_states, 1:10)
```

Convert this data frame into a tidy format with a row-per-sample-per-gene where
the values are the copy number states:

* -2 deletion
* -1 loss
*  0 neutral
*  1 gain
*  2 amplification

Remove the `Entrez_Gene_id` column and convert the copy number state variable
into a factor using the more human-readable names for each state.

```{r}

```

_Hint: look at the help page for `factor()` to see how to set the labels for each copy number state or use `fct_recode()` from the `forcats` package._

Count the total number of occurrences of each copy number state.

```{r}

```

Create a combined data set containing the expression value and copy number state
for each patient and gene pairing. The data frame should contain the columns
Sample, Gene, Expression and Copy_number_state.

```{r}

```

Create a series of box plots for each of the genes with a box-and-whiskers
showing the range of expression values for each copy number state.

```{r}

```

Customize this plot by changing the labels, scales, colours and theme as you
like -- be creative!

Save the plot as a PDF using `ggsave()`.

```{r}

```

---

**9. Extension: Mutual exclusivity of ERBB2 amplifications and AKT1 mutations**

_Seriously, stop here if you haven't got the time or inclination to attempt this final, bonus extension exercise._

In the METABRIC 2016 paper, Pereira _et al._
([Nature Communications 7:11479, 2016](https://www.ncbi.nlm.nih.gov/pubmed/27161491))
considered the association between somatic mutations, exploring patterns of
co-mutation and mutual exclusivity. One of their findings was the mutual
exclusivity between AKT1 mutations and amplification of ERBB2. For the final
exercise we will reproduce this observation.

We'll first need to read the mutation data into R and we're only interested
in those cases where the patient tumour sample was sequenced so we'll read those
in as well.

```{r eval = FALSE, message = FALSE}
mutations <- read_csv("metabric_mutations.csv")
cases_sequenced <- read_tsv("cases_nat_comm_2016.txt", col_names = "Patient_ID")
```

Filter the mutations table to only contain the non-silent mutations in AKT1.

```{r}

```

Add a logical column to the `cases_sequenced` data frame called
`AKT1_mutated` that indicates whether there was a non-silent AKT1 mutation
detected in each patient tumour sample.

Count the number of patients with and without a non-silent AKT1 mutation.

```{r}

```

_Hint: use a `mutate()` with `%in%`._

Filter the copy number states table to only include entries for ERBB2.

Count the number of samples for each ERBB2 copy number state.

```{r}

```

Join the ERBB2 copy number state table to the table we created before
identifying which patient has an AKT1 mutation. The combined data frame should
only contain entries for patients that have been sequenced and for which copy
number data are available.

```{r}

```

Count the numbers of patients with different combinations of ERBB2 copy number
state and mutated AKT1.

```{r}

```

Does this reflect the observation of mutual exclusivity of ERBB2 amplification
and AKT1 mutations?

Create a logical column called `ERBB2_amplified` indicated which patient samples
have amplifications (copy number state 2) in ERBB2.

```{r}

```

Create a 2-by-2 contingency table using `table()` and the `AKT1_mutated` and
`ERBB2_amplified` columns.

```{r}

```

Perform a Fisher exact test on this contingency table.

```{r}

```

